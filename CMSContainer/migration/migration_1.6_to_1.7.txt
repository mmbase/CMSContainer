Migration document:

Part: core
From version: 1.6
To version: 1.7


Execute the following steps below in the given order:

Name: Add a sendtime column in <prefix>_newsletterpublication table
Goal: Used to save/get sendtime,CMSC-1348
Type: sql-script
--- Start script ---
ALTER TABLE mm_newsletterpublication ADD sendtime datetime;
ALTER TABLE live_newsletterpublication ADD sendtime datetime;
--- End script ---
*
*
*

Name: Add google analytics id
Goal: Have a google analytics id per site
ype:  sql-script
--- Start script ---
ALTER TABLE mm_site ADD COLUMN googleanalyticsid VARCHAR(40) NULL;
ALTER TABLE live_site ADD COLUMN googleanalyticsid VARCHAR(40) NULL;
--- End script ---
*
*
*

Name: Add "Click to page" option to the RelatedContentPortlet
Goal: CMSC-1167 Add "Click to page" option to the RelatedContentPortlet
ype:  sql-script
--- Start script ---
update mm_portletparameter set m_key="relatedWindow" where m_key="window" and number in (select pararel.dnumber from mm_portlet portlet, mm_parameterrel pararel, mm_portletdefinition def, mm_definitionrel defrel where def.definition="relatedcontentportlet" and def.number=defrel.dnumber and defrel.snumber=portlet.number and portlet.number=pararel.snumber);
update live_portletparameter set m_key="relatedWindow" where m_key="window" and number in (select pararel.dnumber from live_portlet portlet, live_parameterrel pararel, live_portletdefinition def, live_definitionrel defrel where def.definition="relatedcontentportlet" and def.number=defrel.dnumber and defrel.snumber=portlet.number and portlet.number=pararel.snumber);
--- End script ---
*
*
*


Name: Upgrade MMBase in customer project / implementation
Goal: Upgrade MMBase
Type: do it yourself
--- Start script ---
New:
mmbase.version=1.8.7-20090603
--- End script ---
*
*
*


Name: Migration from page/rssfeed/pagealias to navigationitem table
Goal:  Migrate all page/rssfeed/pagealias to new navigationitem table ,CMSC-1036 Introduce supertype NavigationItem
Type:  sql-script
--- Start script ---
* First start CMSC 1.6 for the first time (it needs to create the navigationitem tables!)
* Execute the following script on database:
INSERT INTO mm_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from mm_page;
INSERT INTO mm_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from mm_rssfeed;
INSERT INTO mm_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from mm_pagealias;

INSERT INTO live_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from live_page;
INSERT INTO live_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from live_rssfeed;
INSERT INTO live_navigationitem select number, otype, owner, creationdate, lastmodifieddate,publishdate,expiredate,lastmodifier,use_expirydate,urlfragment,title,description,inmenu,secure from live_pagealias;
--- End script ---


Name: Upgrade mail.jar to latest 1.4.2 version in Tomcat/lib
Goal: 
Type: do it yourself at all servers
--- Start script ---
Download the latest mail.jar from http://java.sun.com/products/javamail/downloads/index.html or
grab your version from our maven-repo.
If you are using JDK 6.0 or higher, you don't need activation.jar anymore.
--- End script ---
*
*
*


Name: Check for isProduction setting in live and staging context-XMLS
Goal: Keep the TaskModule working
Type: do it yourself
--- Start script ---
The TaskModule does not send emails anymore when production is not true.
Check this setting for both staging and live environments at all production servers.
--- End script ---
*
*
*

Name: Add a intro column and a body column in <prefix>_responseform table
Goal: add intro field and body field in dynamic form & copy description field to intro field & after copying, clean the description field, CMSC-1272
Type:  sql-script
--- Start script ---
ALTER TABLE mm_responseform ADD intro text;
ALTER TABLE mm_responseform ADD body mediumtext;
UPDATE mm_responseform SET intro = description;
UPDATE mm_responseform SET description = NULL;

ALTER TABLE live_responseform ADD intro text;
ALTER TABLE live_responseform ADD body mediumtext;
UPDATE live_responseform SET intro = description;
UPDATE live_responseform SET description = NULL;
--- End script ---
Exceptions/errors/other problems and what to do:
*
*
*

Name:  update the templete jsp
Goal:  change templates jsp to use intro & body field 
       fixed the styling, CMSC-1272
Type:  manual action
Steps:
1. update the following
<div class="kolombestel">
to 
<div class="responseform">

2. update the following
		<mm:field name="description">
			<mm:isnotempty><p><mm:write escape="none"/></p></mm:isnotempty>
		</mm:field>				
to 
	<mm:field name="intro">
		<mm:isnotempty><div class="intro"><mm:write escape="none"/></div></mm:isnotempty>
	</mm:field>
   
   <mm:field name="body">
      <mm:isnotempty><div class="body"><mm:write escape="none"/></div></mm:isnotempty>
   </mm:field>
 
3. update the following
<mm:isnotempty><p class="body"><mm:write escape="none"/></p></mm:isnotempty></mm:field>	
to 
<mm:isnotempty><div class="confirmation"><mm:write escape="none"/></div></mm:isnotempty></mm:field>
 
Exceptions/errors/other problems and what to do:
*
*
*
